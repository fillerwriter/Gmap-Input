(function(a,b,f,h){function e(d,c){this.element=d;this.options=a.extend({},k,c);this.data=new GmapJSON;this._defaults=k;this._name=i;this._map=null;this.init()}var i="gmapInput",k={startPoint:{lat:41.879535,lon:-87.624333,zoom:7},imagePath:"img",featureMaxCount:-1};e.prototype.init=function(){var d=this;this.options.mapState="panning";this.options.currentFeatureType="draw point";this.options.dblClickTimer=h;this._mapcontainer=a(this.element).after('<div class="gmapInputMap"></div>').siblings(".gmapInputMap").get(0);
var c={zoom:this.options.startPoint.zoom,center:new google.maps.LatLng(this.options.startPoint.lat,this.options.startPoint.lon),mapTypeId:google.maps.MapTypeId.ROADMAP,disableDoubleClickZoom:true};this._map=new google.maps.Map(this._mapcontainer,c);this._features=new FeatureManager({map:this._map});google.maps.event.addListener(this._map,"click",function(a){d.click(a)});google.maps.event.addListener(this._map,"dblclick",function(a){d.doubleclick(a)});if(a(this.element).val()!="")try{var g=jQuery.parseJSON(a(this.element).val());
if(g)if(this.data.loadGeoJSON(g),g.type=="GeometryCollection")for(var j in g.geometries)switch(g.geometries[j].type){case "Point":this.drawPoint(g.geometries[j].coordinates);break;case "LineString":this.drawLine(g.geometries[j].coordinates);break;case "Polygon":this.drawPolygon(g.geometries[j].coordinates)}else switch(g.type){case "Point":this.drawPoint(g.coordinates);break;case "LineString":this.drawLine(g.coordinates);break;case "Polygon":this.drawPolygon(g.coordinates)}}catch(b){}this._features.getCurrentFeature().setEditState(GMAP_EDIT_STATE_STATIC);
this._features.setCurrentFeature(null);c=f.createElement("DIV");c=a("<ul>").addClass("control").css({"background-color":"#FFF","list-style":"none","padding-left":0,"float":"left","font-family":'"Helvetica", sans-serif',"font-size":"0.8em",margin:0}).html('<ul class="current"><li>Draw Point</li></ul><ul class="options"><li>Draw Line</li><li>Draw Polygon</li><li>Draw Bounds</li></ul>');c=a("<div>").append(c).append('<div class="dropdown">expand</div>').css({background:"#FFF",border:"1px solid #7895d7",
cursor:"pointer","box-shadow":"1px 1px 2px #999",margin:"5px 5px 0 0",padding:"3px",overflow:"hidden"});a(".dropdown",c).css({background:"url("+this.options.imagePath+"/dropdown.png) center center no-repeat","border-left":"1px solid #000",cursor:"pointer",display:"block","float":"left",height:"11px","text-indent":"-9999px",width:"16px"});a("ul",c).css({"list-style":"none",margin:0,padding:0});a("li",c).css({width:"7em"});a(".options",c).hide();c=c.get(0);this._map.controls[google.maps.ControlPosition.TOP_RIGHT].push(c);
a("li",c).click(function(){a(this).parent().parent().find("li").css({"background-color":"#FFF",color:"#000"});a(this).text()=={"draw point":"Draw Point","draw line":"Draw Line","draw polygon":"Draw Polygon","draw bounds":"Draw Bounds"}[d.options.currentFeatureType]?d.options.mapState=="drawing"?d.options.mapState="panning":(d.options.mapState="drawing",a(this).css({"background-color":"#7895d7",color:"#FFF"})):(d.options.mapState="drawing",a(this).css({"background-color":"#7895d7",color:"#FFF"}));
switch(a(this).text()){case "Draw Point":d.options.currentFeatureType="draw point";break;case "Draw Line":d.options.currentFeatureType="draw line";break;case "Draw Polygon":d.options.currentFeatureType="draw polygon";break;case "Draw Bounds":d.options.currentFeatureType="draw bounds"}d._features.getCurrentFeature().setEditState(GMAP_EDIT_STATE_STATIC);d._features.setCurrentFeature(null)});a(".dropdown",c).click(function(){a(".options").slideToggle("fast")})};e.prototype.getMap=function(){return this._map};
e.prototype.click=function(a,c,g){var b=this._features.getCurrentFeature();if(this.options.mapState=="drawing")switch(this.options.currentFeatureType){case "draw point":this.drawPoint([a.latLng.lat(),a.latLng.lng()]);break;case "draw line":b==h?this.drawLine([[a.latLng.lat(),a.latLng.lng()]]):this.appendPoint([a.latLng.lat(),a.latLng.lng()]);break;case "draw polygon":b==h?this.drawPolygon([[a.latLng.lat(),a.latLng.lng()]]):this.appendPoint([a.latLng.lat(),a.latLng.lng()])}else c!=h?(b=this._features.getCurrentFeature(),
b!=h&&b.setEditState(GMAP_EDIT_STATE_STATIC),this._features.setCurrentFeature(c.getFeatureID()),this.options.currentFeatureType=g,c.setEditState(GMAP_EDIT_STATE_EDIT)):(b=this._features.getCurrentFeature(),b!=h&&b.setEditState(GMAP_EDIT_STATE_STATIC),this._features.setCurrentFeature(null))};e.prototype.doubleclick=function(){alert("HI")};e.prototype.mouseup=function(d){this.data.replaceCoordinate(d.latLng.lat(),d.latLng.lng(),d.featureID);a(this.element).val(this.data.stringify())};e.prototype.drawPoint=
function(d){$this=this;var c=new google.maps.Marker({position:new google.maps.LatLng(d[0],d[1]),map:this._map});google.maps.event.addListener(c,"click",function(a){$this.click(a,this,"Point")});google.maps.event.addListener(c,"dblclick",function(a){$this.doubleclick(a,this,"Point")});this.data.addFeature("Point");this.data.addCoordinate(d[0],d[1]);a(this.element).val(this.data.stringify())};e.prototype.drawLine=function(a){var c=this,b=new GmapFeatureEdit({feature:new google.maps.Polyline,imagePath:this.options.imagePath}),
e=c._features.addFeature(b);b.setFeatureID(e);c._features.setCurrentFeature(e);b.setEditState(GMAP_EDIT_STATE_EDIT);google.maps.event.addListener(b,"click",function(a){c.click(a,this,"Line")});google.maps.event.addListener(b,"dblclick",function(a){c.doubleclick(a,this,"Line")});this.data.addFeature("LineString");for(var f in a)this.appendPoint(a[f])};e.prototype.drawPolygon=function(a){var c=this,b=new GmapFeatureEdit({feature:new google.maps.Polygon,imagePath:this.options.imagePath}),e=c._features.addFeature(b);
b.setFeatureID(e);c._features.setCurrentFeature(e);b.setEditState(GMAP_EDIT_STATE_EDIT);google.maps.event.addListener(b,"click",function(a){c.click(a,this,"Polygon")});google.maps.event.addListener(b,"dblclick",function(a){c.doubleclick(a,this,"Polygon")});google.maps.event.addListener(b,"mouseup",function(a){c.mouseup(a,this,"Polygon")});this.data.addFeature("Polygon");for(var f in a)this.appendPoint(a[f])};e.prototype.appendPoint=function(b){var c=this._features.getCurrentFeature();c!=h&&(c.getPath().push(new google.maps.LatLng(b[0],
b[1])),this.data.addCoordinate(b[0],b[1]),a(this.element).val(this.data.stringify()))};a.fn[i]=function(b){return this.each(function(){a.data(this,"plugin_"+i)||a.data(this,"plugin_"+i,new e(this,b))})}})(jQuery,window,document);function GmapJSON(){this.data=[];this._currentFeature=-1;this.init()}GmapJSON.prototype.init=function(){};GmapJSON.prototype.loadGeoJSON=function(a){this.data=a.type=="GeometryCollection"?a.geometries:Array(a)};GmapJSON.prototype.addFeature=function(a){this._currentFeature++;this.data[this._currentFeature]={type:a,coordinates:[]};return this._currentFeature};GmapJSON.prototype.removeFeature=function(a){return this.data[a]!=void 0?(this.data.splice(a,1),true):false};
GmapJSON.prototype.setCurrentFeature=function(a){return this.data[a]!=void 0?(this._currentFeature=a,true):false};GmapJSON.prototype.addCoordinate=function(a,b,f){if(f==void 0)f=this._currentFeature;this.data[f].type=="Point"?this.data[f].coordinates=[a,b]:this.data[f].coordinates.push([a,b])};GmapJSON.prototype.removeCoordinate=function(){};GmapJSON.prototype.replaceCoordinate=function(a,b,f,h){if(h==void 0)h=this._currentFeature;this.data[h].coordinates[f]=[a,b]};
GmapJSON.prototype.currentFeature=function(){return this.data[this._currentFeature].coordinates};GmapJSON.prototype.stringify=function(){return this.data.length==0?"":JSON.stringify(this.get())};
GmapJSON.prototype.get=function(){if(this.data.length!=0)if(this.data.length==1)return this.data[0];else{var a=[],b;for(b in this.data)if(this.data[b].type=="Polygon"){var f={type:"Polygon",coordinates:[]};f.coordinates[0]=this.data[b].coordinates;a.push(f)}else a.push(this.data[b]);return{type:"GeometryCollection",geometries:a}}};var GMAP_EDIT_STATE_EDIT="edit",GMAP_EDIT_STATE_STATIC="static";
function GmapFeatureEdit(a){this.options=$.extend({},{feature:void 0,"static":{strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:0.35},edit:{strokeColor:"#00FF00",strokeOpacity:0.8,strokeWeight:2,fillColor:"#00FF00",fillOpacity:0.35},imagePath:"img"},a);if(this.options.feature==void 0)throw"Gmap Feature must be defined";this._feature=this.options.feature;this._state=GMAP_EDIT_STATE_STATIC;this._path=this._feature.getPath();this._points=[];this._featureID=-1;this.init()}
GmapFeatureEdit.prototype.init=function(){var a=this;this._feature.setOptions(this.options[this._state]);google.maps.event.addListener(this._path,"insert_at",function(b){a._pathInsertCallback(b)});google.maps.event.addListener(this._feature,"click",function(b){google.maps.event.trigger(a,"click",b)});google.maps.event.addListener(this._feature,"dblclick",function(){google.maps.event.trigger(a,"dblclick")})};GmapFeatureEdit.prototype.getMap=function(){return this._feature.getMap()};
GmapFeatureEdit.prototype.setMap=function(a){this._feature.setMap(a)};GmapFeatureEdit.prototype.getPath=function(){return this._feature.getPath()};GmapFeatureEdit.prototype.setPath=function(a){this._path=a};GmapFeatureEdit.prototype.getEditState=function(){return this._state};GmapFeatureEdit.prototype.setEditState=function(a){if(a==GMAP_EDIT_STATE_EDIT)this._setStateEdit();else if(a==GMAP_EDIT_STATE_STATIC)this._setStateStatic();else throw"Bad edit state option";};
GmapFeatureEdit.prototype._setStateEdit=function(){for(var a in this._points)this._points[a].setVisible(true);this._feature.setOptions(this.options.edit)};GmapFeatureEdit.prototype._setStateStatic=function(){for(var a in this._points)this._points[a].setVisible(false);this._feature.setOptions(this.options["static"])};GmapFeatureEdit.prototype.setFeatureID=function(a){this._featureID=a};GmapFeatureEdit.prototype.getFeatureID=function(){return this._featureID};
GmapFeatureEdit.prototype._pathInsertCallback=function(a){var b=this,f=new google.maps.MarkerImage(this.options.imagePath+"/point-handle.png",new google.maps.Size(15,15),new google.maps.Point(0,0),new google.maps.Point(8,8)),h=this._feature.getMap(),e=new google.maps.Marker({position:this._path.getAt(a),map:h,icon:f,draggable:true});e.meta={id:this._points.length};this._points.push(e);google.maps.event.addListener(e,"drag",function(){b._feature.getPath().setAt(e.meta.id,e.getPosition())});google.maps.event.addListener(e,
"mouseup",function(a){a.featureID=b.getFeatureID();google.maps.event.trigger(b,"mouseup",a)})};function FeatureManager(a){this.options=$.extend({},{map:void 0},a);this.init()}FeatureManager.prototype.init=function(){if(this.options.map==void 0)throw"Map must be defined";this._map=this.options.map;this._features={};this._currentFeatureID=void 0;this._featureIterator=0};FeatureManager.prototype.addFeature=function(a){a.setMap(this._map);this._featureIterator++;this._features[this._featureIterator]=a;return this._featureIterator};
FeatureManager.prototype.removeFeature=function(a){this._features[a].setMap(null);this._features[a]=void 0};FeatureManager.prototype.removeAllFeatures=function(){for(var a in this._features)this._features[a].setMap(null);this._features=[];this._currentFeatureID=void 0};FeatureManager.prototype.setCurrentFeature=function(a){this._currentFeatureID=a};FeatureManager.prototype.getCurrentFeature=function(){if(this._currentFeatureID!=null)return this._features[this._currentFeatureID]};
FeatureManager.prototype.getFeatureAt=function(a){return this._features[a]};FeatureManager.prototype.getStats=function(){};
