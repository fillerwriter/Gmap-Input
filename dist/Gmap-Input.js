(function(a,f,g,i){function h(c,b){this.element=c;this.options=a.extend({},k,b);this.data=new GmapJSON;this._defaults=k;this._name=j;this._map=null;this.init()}var j="gmapInput",k={startPoint:{lat:41.879535,lon:-87.624333,zoom:7},imagePath:"img",featureMaxCount:-1};h.prototype.init=function(){var c=this;this.options.mapState="panning";this.options.currentFeatureType="draw point";this.options.dblClickTimer=i;this._mapcontainer=a(this.element).after('<div class="gmapInputMap"></div>').siblings(".gmapInputMap").get(0);
var b={zoom:this.options.startPoint.zoom,center:new google.maps.LatLng(this.options.startPoint.lat,this.options.startPoint.lon),mapTypeId:google.maps.MapTypeId.ROADMAP,disableDoubleClickZoom:true};this._map=new google.maps.Map(this._mapcontainer,b);this._features=new FeatureManager({map:this._map});google.maps.event.addListener(this._map,"click",function(a){c.click(a)});google.maps.event.addListener(this._map,"dblclick",function(a){c.doubleclick(a)});if(a(this.element).val()!="")try{var d=jQuery.parseJSON(a(this.element).val());
if(d)if(this.data.loadGeoJSON(d),d.type=="GeometryCollection")for(var e in d.geometries)switch(d.geometries[e].type){case "Point":this.drawPoint(d.geometries[e].coordinates);break;case "LineString":this.drawLine(d.geometries[e].coordinates);break;case "Polygon":this.drawPolygon(d.geometries[e].coordinates)}else switch(d.type){case "Point":this.drawPoint(d.coordinates);break;case "LineString":this.drawLine(d.coordinates);break;case "Polygon":this.drawPolygon(d.coordinates)}}catch(f){}b=g.createElement("DIV");
b=a("<ul>").addClass("control").css({"background-color":"#FFF","list-style":"none","padding-left":0,"float":"left","font-family":'"Helvetica", sans-serif',"font-size":"0.8em",margin:0}).html('<ul class="current"><li>Draw Point</li></ul><ul class="options"><li>Draw Line</li><li>Draw Polygon</li><li>Draw Bounds</li></ul>');b=a("<div>").append(b).append('<div class="dropdown">expand</div>').css({background:"#FFF",border:"1px solid #7895d7",cursor:"pointer","box-shadow":"1px 1px 2px #999",margin:"5px 5px 0 0",
padding:"3px",overflow:"hidden"});a(".dropdown",b).css({background:"url("+this.options.imagePath+"/dropdown.png) center center no-repeat","border-left":"1px solid #000",cursor:"pointer",display:"block","float":"left",height:"11px","text-indent":"-9999px",width:"16px"});a("ul",b).css({"list-style":"none",margin:0,padding:0});a("li",b).css({width:"7em"});a(".options",b).hide();b=b.get(0);this._map.controls[google.maps.ControlPosition.TOP_RIGHT].push(b);a("li",b).click(function(){a(this).parent().parent().find("li").css({"background-color":"#FFF",
color:"#000"});a(this).text()=={"draw point":"Draw Point","draw line":"Draw Line","draw polygon":"Draw Polygon","draw bounds":"Draw Bounds"}[c.options.currentFeatureType]?c.options.mapState=="drawing"?c.options.mapState="panning":(c.options.mapState="drawing",a(this).css({"background-color":"#7895d7",color:"#FFF"})):(c.options.mapState="drawing",a(this).css({"background-color":"#7895d7",color:"#FFF"}));switch(a(this).text()){case "Draw Point":c.options.currentFeatureType="draw point";break;case "Draw Line":c.options.currentFeatureType=
"draw line";break;case "Draw Polygon":c.options.currentFeatureType="draw polygon";break;case "Draw Bounds":c.options.currentFeatureType="draw bounds"}c._features.getCurrentFeature().setEditState(GMAP_EDIT_STATE_STATIC);c._features.setCurrentFeature(null)});a(".dropdown",b).click(function(){a(".options").slideToggle("fast")})};h.prototype.getMap=function(){return this._map};h.prototype.click=function(a,b,d){var e=this._features.getCurrentFeature();if(this.options.mapState=="drawing")switch(this.options.currentFeatureType){case "draw point":this.drawPoint([a.latLng.lat(),
a.latLng.lng()]);break;case "draw line":e==i?this.drawLine([[a.latLng.lat(),a.latLng.lng()]]):this.appendPoint([a.latLng.lat(),a.latLng.lng()]);break;case "draw polygon":e==i?this.drawPolygon([[a.latLng.lat(),a.latLng.lng()]]):this.appendPoint([a.latLng.lat(),a.latLng.lng()])}else b!=i?(e=this._features.getCurrentFeature(),e!=i&&e.setEditState(GMAP_EDIT_STATE_STATIC),this._features.setCurrentFeature(b.getFeatureID()),this.options.currentFeatureType=d,b.setEditState(GMAP_EDIT_STATE_EDIT)):(e=this._features.getCurrentFeature(),
e!=i&&e.setEditState(GMAP_EDIT_STATE_STATIC),this._features.setCurrentFeature(null))};h.prototype.doubleclick=function(){alert("HI")};h.prototype.drawPoint=function(c){$this=this;var b=new google.maps.Marker({position:new google.maps.LatLng(c[0],c[1]),map:this._map});google.maps.event.addListener(b,"click",function(a){$this.click(a,this,"Point")});google.maps.event.addListener(b,"dblclick",function(a){$this.doubleclick(a,this,"Point")});this.data.addFeature("Point");this.data.addCoordinate(c[0],c[1]);
a(this.element).val(this.data.stringify())};h.prototype.drawLine=function(a){var b=this,d=new GmapFeatureEdit({feature:new google.maps.Polyline,imagePath:this.options.imagePath}),e=b._features.addFeature(d);d.setFeatureID(e);b._features.setCurrentFeature(e);d.setEditState(GMAP_EDIT_STATE_EDIT);google.maps.event.addListener(d,"click",function(a){b.click(a,this,"Line")});google.maps.event.addListener(d,"dblclick",function(a){b.doubleclick(a,this,"Line")});this.data.addFeature("LineString");for(var f in a)this.appendPoint(a[f])};
h.prototype.drawPolygon=function(a){var b=this,d=new GmapFeatureEdit({feature:new google.maps.Polygon,imagePath:this.options.imagePath}),e=b._features.addFeature(d);d.setFeatureID(e);b._features.setCurrentFeature(e);d.setEditState(GMAP_EDIT_STATE_EDIT);google.maps.event.addListener(d,"click",function(a){b.click(a,this,"Polygon")});google.maps.event.addListener(d,"dblclick",function(a){b.doubleclick(a,this,"Polygon")});this.data.addFeature("Polygon");for(var f in a)this.appendPoint(a[f])};h.prototype.appendPoint=
function(c){var b=this._features.getCurrentFeature();b!=i&&(b.getPath().push(new google.maps.LatLng(c[0],c[1])),this.data.addCoordinate(c[0],c[1]),a(this.element).val(this.data.stringify()))};a.fn[j]=function(c){return this.each(function(){a.data(this,"plugin_"+j)||a.data(this,"plugin_"+j,new h(this,c))})}})(jQuery,window,document);function GmapJSON(){this.data=[];this._currentFeature=-1;this.init()}GmapJSON.prototype.init=function(){};GmapJSON.prototype.loadGeoJSON=function(a){this.data=a.type=="GeometryCollection"?a.geometries:Array(a)};GmapJSON.prototype.addFeature=function(a){this._currentFeature++;this.data[this._currentFeature]={type:a,coordinates:[]};return this._currentFeature};GmapJSON.prototype.removeFeature=function(a){return this.data[a]!=void 0?(this.data.splice(a,1),true):false};
GmapJSON.prototype.setCurrentFeature=function(a){return this.data[a]!=void 0?(this._currentFeature=a,true):false};GmapJSON.prototype.addCoordinate=function(a,f,g){if(g==void 0)g=this._currentFeature;this.data[g].type=="Point"?this.data[g].coordinates=[a,f]:this.data[g].coordinates.push([a,f])};GmapJSON.prototype.removeCoordinate=function(){};GmapJSON.prototype.currentFeature=function(){return this.data[this._currentFeature].coordinates};
GmapJSON.prototype.stringify=function(){return this.data.length==0?"":this.data.length==1?JSON.stringify(this.data[0]):JSON.stringify({type:"GeometryCollection",geometries:this.data})};GmapJSON.prototype.get=function(){if(this.data.length!=0)return this.data.length==1?this.data[0]:{type:"GeometryCollection",geometries:this.data}};var GMAP_EDIT_STATE_EDIT="edit",GMAP_EDIT_STATE_STATIC="static";
function GmapFeatureEdit(a){this.options=$.extend({},{feature:void 0,"static":{strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:0.35},edit:{strokeColor:"#00FF00",strokeOpacity:0.8,strokeWeight:2,fillColor:"#00FF00",fillOpacity:0.35},imagePath:"img"},a);if(this.options.feature==void 0)throw"Gmap Feature must be defined";this._feature=this.options.feature;this._state=GMAP_EDIT_STATE_STATIC;this._path=this._feature.getPath();this._points=[];this._featureID=-1;this.init()}
GmapFeatureEdit.prototype.init=function(){var a=this;this._feature.setOptions(this.options[this._state]);google.maps.event.addListener(this._path,"insert_at",function(f){a._pathInsertCallback(f)});google.maps.event.addListener(this._feature,"click",function(f){google.maps.event.trigger(a,"click",f)});google.maps.event.addListener(this._feature,"dblclick",function(){google.maps.event.trigger(a,"dblclick")})};GmapFeatureEdit.prototype.getMap=function(){return this._feature.getMap()};
GmapFeatureEdit.prototype.setMap=function(a){this._feature.setMap(a)};GmapFeatureEdit.prototype.getPath=function(){return this._feature.getPath()};GmapFeatureEdit.prototype.setPath=function(a){this._path=a};GmapFeatureEdit.prototype.getEditState=function(){return this._state};GmapFeatureEdit.prototype.setEditState=function(a){if(a==GMAP_EDIT_STATE_EDIT)this._setStateEdit();else if(a==GMAP_EDIT_STATE_STATIC)this._setStateStatic();else throw"Bad edit state option";};
GmapFeatureEdit.prototype._setStateEdit=function(){for(var a in this._points)this._points[a].setVisible(true);this._feature.setOptions(this.options.edit)};GmapFeatureEdit.prototype._setStateStatic=function(){for(var a in this._points)this._points[a].setVisible(false);this._feature.setOptions(this.options["static"])};GmapFeatureEdit.prototype.setFeatureID=function(a){this._featureID=a};GmapFeatureEdit.prototype.getFeatureID=function(){return this._featureID};
GmapFeatureEdit.prototype._pathInsertCallback=function(a){var f=new google.maps.MarkerImage(this.options.imagePath+"/point-handle.png",new google.maps.Size(15,15),new google.maps.Point(0,0),new google.maps.Point(8,8)),g=this._feature.getMap();this._points.push(new google.maps.Marker({position:this._path.getAt(a),map:g,icon:f}))};function FeatureManager(a){this.options=$.extend({},{map:void 0},a);this.init()}FeatureManager.prototype.init=function(){if(this.options.map==void 0)throw"Map must be defined";this._map=this.options.map;this._features={};this._currentFeatureID=void 0;this._featureIterator=0};FeatureManager.prototype.addFeature=function(a){a.setMap(this._map);this._featureIterator++;this._features[this._featureIterator]=a;return this._featureIterator};
FeatureManager.prototype.removeFeature=function(a){this._features[a].setMap(null);this._features[a]=void 0};FeatureManager.prototype.removeAllFeatures=function(){for(var a in this._features)this._features[a].setMap(null);this._features=[];this._currentFeatureID=void 0};FeatureManager.prototype.setCurrentFeature=function(a){this._currentFeatureID=a};FeatureManager.prototype.getCurrentFeature=function(){if(this._currentFeatureID!=null)return this._features[this._currentFeatureID]};
FeatureManager.prototype.getFeatureAt=function(a){return this._features[a]};FeatureManager.prototype.getStats=function(){};
