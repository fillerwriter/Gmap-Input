(function(a,h,f,g){function e(b,c){this.element=b;this.options=a.extend({},j,c);this.data=new GmapJSON;this._defaults=j;this._name=i;this._map=null;this.init()}var i="gmapInput",j={startPoint:{lat:41.879535,lon:-87.624333,zoom:7},imagePath:"img",featureMaxCount:-1};e.prototype.init=function(){var b=this;this.options.mapState="panning";this.options.currentFeatureType="draw point";this.options.currentOverlay=g;this.options.dblClickTimer=g;this._features=[];this._mapcontainer=a(this.element).after('<div class="gmapInputMap"></div>').siblings(".gmapInputMap").get(0);
var c={zoom:this.options.startPoint.zoom,center:new google.maps.LatLng(this.options.startPoint.lat,this.options.startPoint.lon),mapTypeId:google.maps.MapTypeId.ROADMAP,disableDoubleClickZoom:true};this._map=new google.maps.Map(this._mapcontainer,c);google.maps.event.addListener(this._map,"click",function(a){b.click(a)});google.maps.event.addListener(this._map,"dblclick",function(a){b.doubleclick(a)});if(a(this.element).val()!="")try{var d=jQuery.parseJSON(a(this.element).val());if(d)if(this.data.loadGeoJSON(d),
d.type=="GeometryCollection")for(var e in d.geometries)switch(d.geometries[e].type){case "Point":this.drawPoint(d.geometries[e].coordinates);break;case "LineString":this.drawLine(d.geometries[e].coordinates);break;case "Polygon":this.drawPolygon(d.geometries[e].coordinates)}else switch(d.type){case "Point":this.drawPoint(d.coordinates);break;case "LineString":this.drawLine(d.coordinates);break;case "Polygon":this.drawPolygon(d.coordinates)}}catch(h){}this.options.currentOverlay=g;c=f.createElement("DIV");
c=a("<ul>").addClass("control").css({"background-color":"#FFF","list-style":"none","padding-left":0,"float":"left","font-family":'"Helvetica", sans-serif',"font-size":"0.8em",margin:0}).html('<ul class="current"><li>Draw Point</li></ul><ul class="options"><li>Draw Line</li><li>Draw Polygon</li><li>Draw Bounds</li></ul>');c=a("<div>").append(c).append('<div class="dropdown">expand</div>').css({background:"#FFF",border:"1px solid #7895d7",cursor:"pointer","box-shadow":"1px 1px 2px #999",margin:"5px 5px 0 0",
padding:"3px",overflow:"hidden"});a(".dropdown",c).css({background:"url("+this.options.imagePath+"/dropdown.png) center center no-repeat","border-left":"1px solid #000",cursor:"pointer",display:"block","float":"left",height:"11px","text-indent":"-9999px",width:"16px"});a("ul",c).css({"list-style":"none",margin:0,padding:0});a("li",c).css({width:"7em"});a(".options",c).hide();c=c.get(0);this._map.controls[google.maps.ControlPosition.TOP_RIGHT].push(c);a("li",c).click(function(){a(this).parent().parent().find("li").css({"background-color":"#FFF",
color:"#000"});a(this).text()=={"draw point":"Draw Point","draw line":"Draw Line","draw polygon":"Draw Polygon","draw bounds":"Draw Bounds"}[b.options.currentFeatureType]?b.options.mapState=="drawing"?b.options.mapState="panning":(b.options.mapState="drawing",a(this).css({"background-color":"#7895d7",color:"#FFF"})):(b.options.mapState="drawing",a(this).css({"background-color":"#7895d7",color:"#FFF"}));switch(a(this).text()){case "Draw Point":b.options.currentFeatureType="draw point";break;case "Draw Line":b.options.currentFeatureType=
"draw line";break;case "Draw Polygon":b.options.currentFeatureType="draw polygon";break;case "Draw Bounds":b.options.currentFeatureType="draw bounds"}b.options.currentOverlay.setEditState(GMAP_EDIT_STATE_STATIC);b.options.currentOverlay=g});a(".dropdown",c).click(function(){a(".options").slideToggle("fast")})};e.prototype.getMap=function(){return this._map};e.prototype.click=function(a,c,d){if(this.options.mapState=="drawing")switch(this.options.currentFeatureType){case "draw point":this.drawPoint([a.latLng.lat(),
a.latLng.lng()]);break;case "draw line":this.options.currentOverlay==g?this.drawLine([[a.latLng.lat(),a.latLng.lng()]]):this.appendPoint([a.latLng.lat(),a.latLng.lng()]);break;case "draw polygon":this.options.currentOverlay==g?this.drawPolygon([[a.latLng.lat(),a.latLng.lng()]]):this.appendPoint([a.latLng.lat(),a.latLng.lng()])}else c!=g?(this.options.currentOverlay=c,this.options.currentFeatureType=d,this.options.currentOverlay._setStateEdit()):(this.options.currentOverlay._setStateStatic(),this.options.currentOverlay=
g)};e.prototype.doubleclick=function(){alert("HI")};e.prototype.drawPoint=function(b){$this=this;var c=new google.maps.Marker({position:new google.maps.LatLng(b[0],b[1]),map:this._map});google.maps.event.addListener(c,"click",function(a){$this.click(a,this,"Point")});google.maps.event.addListener(c,"dblclick",function(a){$this.doubleclick(a,this,"Point")});this.data.addFeature("Point");this.data.addCoordinate(b[0],b[1]);a(this.element).val(this.data.stringify())};e.prototype.drawLine=function(a){$gmapinput=
this;this.options.currentOverlay=new GmapFeatureEdit({feature:new google.maps.Polyline});this.options.currentOverlay.setMap(this._map);this.options.currentOverlay._setStateEdit();google.maps.event.addListener(this.options.currentOverlay,"click",function(a){$gmapinput.click(a,this,"Line")});google.maps.event.addListener(this.options.currentOverlay,"dblclick",function(a){$gmapinput.doubleclick(a,this,"Line")});this.data.addFeature("LineString");for(var c in a)this.appendPoint(a[c])};e.prototype.drawPolygon=
function(a){$gmapinput=this;var c=new GmapFeatureEdit({feature:new google.maps.Polygon});this.options.currentOverlay=c;this.options.currentOverlay.setMap(this._map);this.options.currentOverlay._setStateEdit();google.maps.event.addListener(c,"click",function(a){var b=this.getPath().getAt(0);alert("DRAW PROTOTYPE: "+b.lat());$gmapinput.click(a,this,"Polygon")});google.maps.event.addListener(this.options.currentOverlay,"dblclick",function(a){$gmapinput.doubleclick(a,this,"Polygon")});this.data.addFeature("Polygon");
for(var d in a)this.appendPoint(a[d])};e.prototype.appendPoint=function(b){this.options.currentOverlay!=g&&(this.options.currentOverlay.getPath().push(new google.maps.LatLng(b[0],b[1])),this.data.addCoordinate(b[0],b[1]),a(this.element).val(this.data.stringify()))};a.fn[i]=function(b){return this.each(function(){a.data(this,"plugin_"+i)||a.data(this,"plugin_"+i,new e(this,b))})}})(jQuery,window,document);function GmapJSON(){this.data=[];this._currentFeature=-1;this.init()}GmapJSON.prototype.init=function(){};GmapJSON.prototype.loadGeoJSON=function(a){this.data=a.type=="GeometryCollection"?a.geometries:Array(a)};GmapJSON.prototype.addFeature=function(a){this._currentFeature++;this.data[this._currentFeature]={type:a,coordinates:[]};return this._currentFeature};GmapJSON.prototype.removeFeature=function(a){return this.data[a]!=void 0?(this.data.splice(a,1),true):false};
GmapJSON.prototype.setCurrentFeature=function(a){return this.data[a]!=void 0?(this._currentFeature=a,true):false};GmapJSON.prototype.addCoordinate=function(a,h,f){if(f==void 0)f=this._currentFeature;this.data[f].type=="Point"?this.data[f].coordinates=[a,h]:this.data[f].coordinates.push([a,h])};GmapJSON.prototype.removeCoordinate=function(){};GmapJSON.prototype.currentFeature=function(){return this.data[this._currentFeature].coordinates};
GmapJSON.prototype.stringify=function(){return this.data.length==0?"":this.data.length==1?JSON.stringify(this.data[0]):JSON.stringify({type:"GeometryCollection",geometries:this.data})};GmapJSON.prototype.get=function(){if(this.data.length!=0)return this.data.length==1?this.data[0]:{type:"GeometryCollection",geometries:this.data}};var GMAP_EDIT_STATE_EDIT="edit",GMAP_EDIT_STATE_STATIC="static";function GmapFeatureEdit(a){this.options=$.extend({},{feature:void 0,"static":{strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:0.35},edit:{strokeColor:"#00FF00",strokeOpacity:0.8,strokeWeight:2,fillColor:"#00FF00",fillOpacity:0.35}},a);if(this.options.feature==void 0)throw"Gmap Feature must be defined";this.init()}
GmapFeatureEdit.prototype.init=function(){$this=this;this._feature=this.options.feature;this._state=GMAP_EDIT_STATE_STATIC;this._path=this._feature.getPath();this._points=[];this._feature.setOptions(this.options[this._state]);google.maps.event.addListener(this._path,"insert_at",function(a){$this._pathInsertCallback(a)});google.maps.event.addListener(this._feature,"click",function(a){var h=this.getPath().getAt(0);alert("GMAP FEATURE: "+h.lat());google.maps.event.trigger($this,"click",a)});google.maps.event.addListener(this._feature,
"dblclick",function(){google.maps.event.trigger($this,"dblclick")})};GmapFeatureEdit.prototype.getMap=function(){return this._feature.getMap()};GmapFeatureEdit.prototype.setMap=function(a){this._feature.setMap(a)};GmapFeatureEdit.prototype.getPath=function(){return this._feature.getPath()};GmapFeatureEdit.prototype.setPath=function(a){this._path=a};GmapFeatureEdit.prototype.getEditState=function(){return this._state};
GmapFeatureEdit.prototype.setEditState=function(a){if(a==GMAP_EDIT_STATE_EDIT)this._setStateEdit();else if(a==GMAP_EDIT_STATE_STATIC)this._setStateStatic();else throw"Bad edit state option";};GmapFeatureEdit.prototype._setStateEdit=function(){for(var a in this._points)this._points[a].setVisible(true);this._feature.setOptions(this.options.edit)};GmapFeatureEdit.prototype._setStateStatic=function(){for(var a in this._points)this._points[a].setVisible(false);this._feature.setOptions(this.options["static"])};
GmapFeatureEdit.prototype._pathInsertCallback=function(a){var h=new google.maps.MarkerImage("img/point-handle.png",new google.maps.Size(15,15),new google.maps.Point(0,0),new google.maps.Point(8,8)),f=$this._feature.getMap();this._points.push(new google.maps.Marker({position:this._path.getAt(a),map:f,icon:h}))};
