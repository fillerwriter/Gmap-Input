(function(a,b,h,j){function f(d,c){this.element=d;this.options=a.extend({},i,c);this._defaults=i;this._name=k;this._infoWindow=this._features=this._dblClickTimer=this._drawManager=this._bounds=this._mapcontainer=this._map=null;this.init()}var k="gmapInput",i={startPoint:{lat:41.879535,lon:-87.624333,zoom:7},properties:j,imagePath:"img",featureMaxCount:-1,widgetOptions:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.POLYLINE,google.maps.drawing.OverlayType.POLYGON],defaultWidgetOption:null,
forceGeoCollection:false,mapOptions:{mapTypeId:google.maps.MapTypeId.ROADMAP}};f.prototype.init=function(){var d=this;this.options.mapState="panning";this._dblClickTimer=j;this._mapcontainer=a(this.element).after('<div class="gmapInputMap"></div>').siblings(".gmapInputMap").get(0);var c={zoom:this.options.startPoint.zoom,center:new google.maps.LatLng(this.options.startPoint.lat,this.options.startPoint.lon),mapTypeId:this.options.mapOptions.mapTypeId,disableDoubleClickZoom:true};this._map=new google.maps.Map(this._mapcontainer,
c);this._features=new FeatureManager({map:this._map,element:this.element,forceGeoCollection:this.options.forceGeoCollection});c=this._features.getLength();if(c>0){this._map.fitBounds(this._features.getBounds());for(var g=0;g<c;g++)this.featureEventsRegister(this._features.getFeatureAt(g))}this._drawManager=new google.maps.drawing.DrawingManager({map:this._map,drawingControlOptions:{drawingModes:this.options.widgetOptions,position:google.maps.ControlPosition.TOP_LEFT},markerOptions:{draggable:true},
polylineOptions:{editable:true}});c="";if(d.options.properties){c+="<form class='map-property-form'>";for(var e in d.options.properties)c+="<div class='"+e+"-wrapper'><label>"+e+":</label><input name='"+e+"-input' class='"+e+"-input' value='"+d.options.properties[e]+"'/></div>";c+="<div><input type='submit' value='Save' /></form>"}c+="<p><a class='deleteLink' href='#'>Delete</a></p>";this._infoWindow=new google.maps.InfoWindow({content:c});google.maps.event.addListener(this._map,"click",function(a){d.click(a)});
google.maps.event.addListener(this._infoWindow,"closeclick",function(){var a=d._features.getCurrentFeature();!a.getPos&&a.setEditable&&a.setEditable(false);d._features.setCurrentFeature(j)});google.maps.event.addListener(this._drawManager,"overlaycomplete",function(c){var e=c.overlay;c.type==google.maps.drawing.OverlayType.POLYGON&&e.getPath().getLength()<2?e.setMap(null):(d.options.properties&&e.set("geojsonProperties",d.options.properties),d.options.featureMaxCount==1&&d._features.getLength()>0&&
d._features.removeAllFeatures(),d._features.addFeature(e),a(d.element).val(JSON.stringify(d._features.getGeoJSON())),this.setDrawingMode(null),d._features.setCurrentFeature(e.get("fmPos")),e.type=c.type,d.featureEventsRegister(e),e.type!="marker"&&e.setEditable(true),d.options.properties!=j&&d._openInfoWindow(e))})};f.prototype.version=function(){return"0.2"};f.prototype.getMap=function(){return this._map};f.prototype.getDrawManager=function(){return this._drawManager};f.prototype.click=function(a,
c,g){var e=this;this._dblClickTimer=setTimeout(function(){e._click(a,c,g)},200)};f.prototype._click=function(d,c){if(c==j){var g=this._features.getCurrentFeature();g&&(g.type!="marker"&&g.setEditable(false),this._features.setCurrentFeature(null),a(this.element).val(JSON.stringify(this._features.getGeoJSON())))}};f.prototype.doubleclick=function(){clearTimeout(this._dblClickTimer)};f.prototype.rightclick=function(){};f.prototype._openInfoWindow=function(d){var c=this;d==j&&(d=c._feature.getCurrentFeature());
var g=d.get("localBounds");c._infoWindow.setPosition(g.getCenter());c._infoWindow.open(c._map);var d=d.get("geojsonProperties"),e;for(e in d)a("."+e+"-input").val(d[e]);a(".deleteLink").click(function(d){d.preventDefault();d=c._features.getCurrentFeature();c._features.removeFeatureAt(d.get("fmPos"));a(c.element).val(JSON.stringify(c._features.getGeoJSON()));c._infoWindow.close()});a(".map-property-form").submit(function(){var d=c._features.getCurrentFeature(),e={},g;for(g in c.options.properties)e[g]=
a("."+g+"-input").val();d.set("geojsonProperties",e);c._features.modifyFeature(d,d.get("fmPos"));c._infoWindow.close();a(c.element).val(JSON.stringify(c._features.getGeoJSON()));return false})};f.prototype.featureEventsRegister=function(d){var c=this,g=d.get("type");g=="polygon"||g=="polyline"?(g=d.getPath(),google.maps.event.addListener(g,"insert_at",function(){var a=c._features.getCurrentFeature();c._features.modifyFeature(a,a.get("fmPos"))})):g=="marker"&&(d.setDraggable(true),google.maps.event.addListener(d,
"dragend",function(){var d=this.get("fmPos");c._features.modifyFeature(this,d);a(c.element).val(JSON.stringify(c._features.getGeoJSON()));c._infoWindow.close()}));google.maps.event.addListener(d,"click",function(){c._features.setCurrentFeature(this.get("fmPos"));d.get("type")!="marker"&&d.setEditable(true)});google.maps.event.addListener(d,"dblclick",function(){c._features.setCurrentFeature(this.get("fmPos"));c._openInfoWindow(d)})};a.fn[k]=function(d){return this.each(function(){a.data(this,k)||
a.data(this,k,new f(this,d))})}})(jQuery,window,document);var GeoJSON=function(a,b){var h=function(a,c,g){var e;switch(a.type){case "Point":c.position=new google.maps.LatLng(a.coordinates[1],a.coordinates[0]);e=new google.maps.Marker(c);g&&e.set("geojsonProperties",g);break;case "MultiPoint":e=[];for(var b=0;b<a.coordinates.length;b++)c.position=new google.maps.LatLng(a.coordinates[b][1],a.coordinates[b][0]),e.push(new google.maps.Marker(c));if(g)for(var f=0;f<e.length;f++)e[f].set("geojsonProperties",g);break;case "LineString":for(var i=[],b=0;b<a.coordinates.length;b++){var f=
a.coordinates[b],k=new google.maps.LatLng(f[1],f[0]);i.push(k)}c.path=i;e=new google.maps.Polyline(c);g&&e.set("geojsonProperties",g);break;case "MultiLineString":e=[];for(b=0;b<a.coordinates.length;b++){for(var i=[],l=0;l<a.coordinates[b].length;l++)f=a.coordinates[b][l],k=new google.maps.LatLng(f[1],f[0]),i.push(k);c.path=i;e.push(new google.maps.Polyline(c))}if(g)for(f=0;f<e.length;f++)e[f].set("geojsonProperties",g);break;case "Polygon":for(var m=[],b=0;b<a.coordinates.length;b++){i=[];for(l=
0;l<a.coordinates[b].length;l++)k=new google.maps.LatLng(a.coordinates[b][l][1],a.coordinates[b][l][0]),i.push(k);m.push(i)}c.paths=m;e=new google.maps.Polygon(c);g&&e.set("geojsonProperties",g);break;case "MultiPolygon":e=[];for(b=0;b<a.coordinates.length;b++){m=[];for(l=0;l<a.coordinates[b].length;l++){i=[];for(f=0;f<a.coordinates[b][l].length;f++)k=new google.maps.LatLng(a.coordinates[b][l][f][1],a.coordinates[b][l][f][0]),i.push(k);m.push(i)}c.paths=m;e.push(new google.maps.Polygon(c))}if(g)for(f=
0;f<e.length;f++)e[f].set("geojsonProperties",g);break;case "GeometryCollection":e=[];if(a.geometries)for(b=0;b<a.geometries.length;b++)e.push(h(a.geometries[b],c,g||null));else e=j('Invalid GeoJSON object: GeometryCollection object missing "geometries" member.');break;default:e=j('Invalid GeoJSON object: Geometry object must be one of "Point", "LineString", "Polygon" or "MultiPolygon".')}return e},j=function(a){return{type:"Error",message:a}},f,k=b||{};switch(a.type){case "FeatureCollection":if(a.features){f=
[];for(var i=0;i<a.features.length;i++)f.push(h(a.features[i].geometry,k,a.features[i].properties))}else f=j('Invalid GeoJSON object: FeatureCollection object missing "features" member.');break;case "GeometryCollection":if(a.geometries){f=[];for(i=0;i<a.geometries.length;i++)f.push(h(a.geometries[i],k,a.geometries[i].properties))}else f=j('Invalid GeoJSON object: GeometryCollection object missing "geometries" member.');break;case "Feature":f=!a.properties||!a.geometry?j('Invalid GeoJSON object: Feature object missing "properties" or "geometry" member.'):
h(a.geometry,k,a.properties);break;case "Point":case "MultiPoint":case "LineString":case "MultiLineString":case "Polygon":case "MultiPolygon":f=a.coordinates?f=h(a,k,a.properties):j('Invalid GeoJSON object: Geometry object missing "coordinates" member.');break;default:f=j('Invalid GeoJSON object: GeoJSON object must be one of "Point", "LineString", "Polygon", "MultiPolygon", "Feature", "FeatureCollection" or "GeometryCollection".')}return f};function FeatureManager(a){this.options=jQuery.extend({},{map:void 0,element:void 0,geojson:void 0,forceGeoCollection:false},a);this._bounds=this._element=this._featureIterator=this._currentFeatureId=this._features=this._map=null;this.init()}
FeatureManager.prototype.init=function(){var a=this;if(this.options.map==void 0)throw"Map must be defined";if(this.options.element==void 0&&this.options.geojson==void 0)throw"Either geojson or element must be defined";this._map=this.options.map;this._features=new google.maps.MVCArray;this._currentFeatureID=void 0;this._featureIterator=0;this._element=this.options.element;this._bounds=new google.maps.LatLngBounds;var b=void 0;if(jQuery(this._element).val()!="")b=jQuery.parseJSON(jQuery(this._element).val());
else if(this.options.geojson!=void 0)b=this.options.geojson;if(b)if(b=GeoJSON(b),b.type=="Error")alert("ERROR");else if(jQuery.isArray(b))for(var h in b)this.addFeature(b[h]);else this.addFeature(b);google.maps.event.addListener(this._features,"insert_at",function(){a._resetInternals()});google.maps.event.addListener(this._features,"remove_at",function(){a._resetInternals()});google.maps.event.addListener(this._features,"set_at",function(){a._resetInternals()})};
FeatureManager.prototype.addFeature=function(a){var b=void 0,h=new google.maps.LatLngBounds;if(a.getPaths){var b="polygon",j=a.getPath();j.forEach(function(a){h.extend(a)})}else a.getPath?(b="polyline",j=a.getPath(),j.forEach(function(a){h.extend(a)})):a.getPosition&&(b="marker",h.extend(a.getPosition()));a.set("type",b);a.set("localBounds",h);a.set("fmPos",this._features.getLength());this._features.push(a);this._bounds.union(h);a.setMap(this._map)};
FeatureManager.prototype.modifyFeature=function(a,b){this._features.getAt(b);var h=new google.maps.LatLngBounds;a.getPath?a.getPath().forEach(function(a){h.extend(a)}):a.getPosition&&h.extend(a.getPosition());a.set("localBounds",h);this._features.setAt(b,a)};FeatureManager.prototype.removeFeatureAt=function(a){this._features.getAt(a).setMap(null);this._features.removeAt(a)};
FeatureManager.prototype.removeAllFeatures=function(){this._features.forEach(function(a){a.setMap(null)});this._features=new google.maps.MVCArray;this._currentFeatureID=void 0};FeatureManager.prototype._resetInternals=function(){var a=this;this._bounds=new google.maps.LatLngBounds;this._features.forEach(function(b,h){a._bounds.union(b.get("localBounds"));b.set("fmPos",h)})};FeatureManager.prototype.setCurrentFeature=function(a){this._currentFeatureID=a};
FeatureManager.prototype.getCurrentFeature=function(){if(this._currentFeatureID!=null)return this._features.getAt(this._currentFeatureID)};FeatureManager.prototype.getFeatureAt=function(a){return this._features.getAt(a)};FeatureManager.prototype.getFeatures=function(){return this._features.getArray()};FeatureManager.prototype.getLength=function(){return this._features.getLength()};FeatureManager.prototype.getMap=function(){return this._map};FeatureManager.prototype.getElement=function(){return this._element};
FeatureManager.prototype.getBounds=function(){return this._bounds};FeatureManager.prototype.getGeoJSON=function(){var a={},b=this;if(this._features.getLength()==0)a=void 0;else if(this.options.forceGeoCollection==false&&this._features.getLength()==1)a=this._GeoJSONParse(this._features.getAt(0));else{var h=[];this._features.forEach(function(a){h.push(b._GeoJSONParse(a))});a={type:"GeometryCollection",geometries:h}}return a};
FeatureManager.prototype._GeoJSONParse=function(a){var b=a.get("geojsonProperties");if(a.getPaths){var h=[];a.getPaths().forEach(function(a){var b=[];a.forEach(function(a){b.push([a.lng(),a.lat()])});h.push(b)});return{type:"Polygon",coordinates:h,properties:b}}else if(a.getPath)return a=a.getPath(),h=[],a.forEach(function(a){h.push([a.lng(),a.lat()])}),{type:"LineString",coordinates:h,properties:b};else if(a.getPosition)return a=a.getPosition(),{type:"Point",coordinates:[a.lng(),a.lat()],properties:b}};
